## 服务器节点类型

- leader 可读可写

- follower 只负责读，还可参与选举

- observer 可以读，但无法选举

**四种状态**

1. Looking 选举状态
2. Following 
3. Leading
4. Observing

## ZAB协议（原子广播协议）

Zookeeper 客户端会随机的链接到 zookeeper 集群中的一个节点，如果是读请求，就直接从当前节点中读取数据；如果是写请求，那么节点就会向 Leader 提交事务，Leader 接收到事务提交，会广播该事务，只要超过半数节点写入成功，该事务就会被提交。

### 选举机制

*选举时使用的是BIO通信模式*

### Epoch：逻辑时钟

或者叫投票的次数，同一轮投票过程中的逻辑时钟值是相同的。每投完一次票这个数据就会增加，然后与接收到的其它服务器返回的投票信息中的数值相比，根据不同的值做出不同的判断。

"选票"包括myid和事务zid，每个节点内部先比较事务zid，投给zid大的节点，如果zid一样选myid大的节点

**（1）服务器1启动**

发起一次选举，服务器1投自己一票，此时服务器1票数一票，不够半数以上（3票），选举无法完成。

投票结果：服务器1为1票。

服务器1状态保持为LOOKING。

**（2）服务器2启动**

发起一次选举，服务器1和2分别投自己一票，此时服务器1发现服务器2的id比自己大，更改选票投给服务器2。

投票结果：服务器1为0票，服务器2为2票。

服务器1，2状态保持LOOKING

**（3）服务器3启动**

发起一次选举，服务器1、2、3先投自己一票，然后因为服务器3的id最大，两者更改选票投给为服务器3；

投票结果：服务器1为0票，服务器2为0票，服务器3为3票。此时服务器3的票数已经超过半数（3票），**服务器3当选****Leader**。

服务器1，2更改状态为FOLLOWING，服务器3更改状态为LEADING。

**（4）服务器4启动**

发起一次选举，此时服务器1，2，3已经不是LOOKING 状态，不会更改选票信息。交换选票信息结果：服务器3为3票，服务器4为1票。此时服务器4服从多数，更改选票信息为服务器3。

服务器4并更改状态为FOLLOWING。

**（5）服务器5启动**

与服务器4一样投票给3，此时服务器3一共5票，服务器5为0票。服务器5并更改状态为FOLLOWING。

###  主从数据同步

![image-20220111211955458](E:\学习笔记\typora\img\image-20220111211955458.png)

## CAP理论

一个分布式系统只能满足一致性、可用性、分区容错性三个中的两个。zk满足了CP