### 内存管理

Linux 操作系统是采用段页式内存管理方式： 页式存储管理能有效地提高内存利用率（解决内存碎片）,而分段存储管理能反映程序的逻辑结构并有利于段的共享。将这两种存储管理方法结合起来,就形成了段页式存储管理方式。 段页式存储管理方式即先将用户程序分成若干个段,再把每个段分成若干个页,并为每一个段赋予一个段名。在段页式系统中,为了实现从逻辑地址到物理地址的转换,系统中需要同时配置段表和页表,利用段表和页表进行从用户地址空间到物理内存空间的映射。 系统为每一个进程建立一张段表,每个分段有一张页表。段表表项中至少包括段号、页表长度和页表始址,页表表项中至少包括页号和块号。在进行地址转换时,首先通过段表查到页表始址,然后通过页表找到页帧号,最终形成物理地址。

![image-20220323140258298](E:\学习笔记\typora\img\image-20220323140258298.png)

**交换技术**

把某些进程挂起暂时换出外存，调入其他进程运行。（PCB会留在内存）磁盘被分为文件曲和对换区，对换区采用连续分配，IO速度快。

## 内存分配

1. 连续分配，原始操作系统使用此种方式。会浪费内存，产生内部碎片
2. 固定分配，使用一张表记录空间分配与否。会产生内部碎片
3. 动态分区分配，根据进程所需动态分配。使用链表记录空闲分区，会产生外部碎片

**分配算法**

1. 首次适应，低地址开始遍历，找到第一个空闲分区
2. 最佳适应，尽量留下较大的空闲内存，空闲分区按容量递增。会留下小的外部碎皮
3. 最坏适应，优先使用最大空闲内存
4. 邻近适应，从上次分配的地址开始查找

### 分页储存管理

把内存分区，一个区叫做页框或者内存块

再把进程分为一个一个小部分放入不同分区,一个小部分叫做页

页和页框根据页表联系起来，页表的一项叫做页表项。

逻辑地址+该页的起始地址就是物理地址。

假设一个页4KB

![image-20220326152118859](E:\学习笔记\typora\img\image-20220326152118859.png)

划线的12位数就是偏移地址.

有K位表示偏移量，说明了一页的大小是2^k内存单元. M位表示页号，说明一个进程最多有2^M个页

逻辑地址 = 页号 + 页内偏移量

查询页表根据页号找到内存块号，用内存块号 + 页内偏移量得到物理地址

![image-20220328175532210](E:\学习笔记\typora\img\image-20220328175532210.png)

![image-20220328180112985](E:\学习笔记\typora\img\image-20220328180112985.png)

**程序局部性原理**

一个程序在一段时间访问了某个内存，在这段时间内访问这块内存的概率很大。

与之相关的是**快表TLB**，相当于页表的缓存。快表未命中就需要访存两次。

**二级页表**

为页表分组，访存3次

![image-20220329182140227](E:\学习笔记\typora\img\image-20220329182140227.png)

**分段**

段长可能不一样，将进程的内存由功能划分为不同段。段表项固定为6KB。分段对用户不透明，分段更容易实现对信息的共享与保护。

![image-20220330171750626](E:\学习笔记\typora\img\image-20220330171750626.png)

**请求分页**

缺页中断机构

![image-20220331215119652](E:\学习笔记\typora\img\image-20220331215119652.png)

内存不够时淘汰页面调到外存，将需要的页面调入内存

**缺页中断**

 A. 在内存中有空闲物理页面时，分配一物理页帧f，转第E步；

  B. 依据页面置换算法选择被替换的物理页帧f，对应逻辑页q；

  C. 如果q被修改过，则把它写回外存；

  D. 修改q的页表项中驻留位置为0；

  E. 将需要访问的页p装入到物理页f；

  F. 修改p的页表项驻留位为1，物理页帧号为f；

  G. 重新执行产生缺页的指令。

**页面置换算法**

1. 最长时间内不再访问的页面

2. 先进先出FIFO

3. LRU

4. 时钟置换法：页面设置访问位，用指针连接成循环队列。标志位0表示最近没访问过，扫描过后访问位置为0

5. 优化后的时钟置换：（1，1）表示访问过且修改过

   ![image-20220401215904152](E:\学习笔记\typora\img\image-20220401215904152.png)

**页面分配置换策略**

==驻留集：请求分页给进程分配的的物理块的集合==

- 固定分配局部置换
- 可变分配全局置换
- 可变分配局部置换

可变：进程被分配的物理块不是固定大小

局部：缺页了只能置换本进程内的物理块
