![image-20210821131728503](E:\学习笔记\typora\img\image-20210821131728503.png)

在 MySQL数据库的 InnoDB存储引擎中，**主键索引就是聚集索引**，所有数据都会按照主键索引进行组织；聚集索引叶子上全是表的数据，我们自定义的索引都是二级索引，是为了找到聚集索引而设置的。

- 普通索引是MySQL中的基本索引类型，允许在定义索引的列中插入重复值和空值。

- 唯一索引要求索引列的值必须唯一，但允许有空值。如果是组合索引，则列值的组合必须唯一。
- 主键索引是一种特殊的唯一索引，不允许有空值。

**MyISAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。而在InnoDB中，表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是主索引。**

### 相关语法

```sql
create index [index_name] on table_name(column) 

show index from table

drop index index_name on table_name

alter table table_name add index index_name(column)

select * from tb_name use index() 指定某个索引

select * from tb_name ignore index() 忽略某个索引

select * from tb_name force index() 强制使用某个索引
```

### 索引失效

- 范围查询后的字段会失效
- 索引列上做函数操作会导致索引失效
- 字符串不加单引号会失效
- or条件会导致索引失效，可以用union替代
- 如果使用索引比不用慢，则mysql会不使用索引
- 使用SELECT *会导致回表查询，MySQL 认为回表的代价比全表扫描更大，所以不选择使用索引。可以使用覆盖索引或者在数据小的情况下加上limit
- is null 和 is not null也会导致索引失效，不过得根据null值多少来决定
- in走索引，not in不走索引
- 使用不等于<>条件时会全表扫描
- order by后字段的顺序与索引顺序不一样会导致内排序， order by和group by会用上索引但不统计在key_len中
- mysql查询只使用一个索引，因此如果where子句中已经使用了索引的话，那么order by中的列是不会使用索引的。

### 优化

- 尽量使用数字型字段
- 大语句拆小语句
- 复合索引的建立需要进行仔细分析，尽量考虑用单字段索引代替
- 表的主键、外键必须有索引


### filesort

一次扫描法：一次排序，排序后直接输出结果集，效率高，内存开销打

二次扫描法：根据条件取出排序字段和行指针，在sort buffer中排序，在临时表中储存结果，会导致大量随机IO

增大max_length_for_sort_data和sort_buffer_size大小提高排序效率

## 概念

#### 索引选择性

索引选择性：不重复的索引值（也称为基数，cardinality）和数据表的记录总数的比值，比值越高，代表索引的选择性越好，唯一索引的选择性是最好的，比值是 1。

#### 索引下推

一句话说就是把索引列的判断条件交给了索引引擎判断，而不是server，减少了回表查询的记录数量

- 在不使用ICP的情况下，在使用非主键索引（又叫普通索引或者二级索引）进行查询时，存储引擎通过索引检索到数据，然后返回给MySQL服务器，服务器然后判断数据是否符合条件 。
- 在使用ICP的情况下，如果存在某些被索引的列的判断条件时，MySQL服务器将这一部分判断条件传递给存储引擎，然后由存储引擎通过判断索引是否符合MySQL服务器传递的条件，只有当索引符合条件时才会将数据检索出来返回给MySQL服务器 。
- 索引条件下推优化可以减少存储引擎查询基础表的次数，也可以减少MySQL服务器从存储引擎接收数据的次数。

#### 三星法则

1. 第一颗星：WHERE 后面参与查询的列可以组成了单列索引或联合索引
2. 第二颗星：避免排序，即如果 SQL 语句中出现 order by colulmn，那么取出的结果集就已经是按照 column 排序好的，不需要再生成临时表
3. 第三颗星：SELECT 对应的列应该尽量是索引列，即尽量避免回表查询。
